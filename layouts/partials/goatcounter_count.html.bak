{{ $goatcounterUrl := printf "https://pporeddy.goatcounter.com/counter/%s.json" (.RelPermalink | urlquery) }}

{{/* Hugo passes the numeric value as a string, so we must define it here: */}}
{{ $historic := default 134 .Params.historic_views }}

<span class="goatcounter-views">
    <script>
        // 1. Get the historic count and ensure it is parsed as a number.
        var historicViews = parseInt({{ $historic }});

        var r = new XMLHttpRequest();
        r.addEventListener('load', function () {
            var data = JSON.parse(this.responseText);
            var totalViews = historicViews;

            // 2. Get the live unique count and ensure it is parsed as a number.
            if (data && data.count_unique) {
                // The crucial fix is wrapping data.count_unique with parseInt()
                totalViews += parseInt(data.count_unique);
            }

            // Display the final calculated total
            document.getElementById('gc-{{ .File.UniqueID }}').innerText = totalViews.toLocaleString() + ' views';
        })
        r.open('GET', '{{ $goatcounterUrl }}')
        r.send()
    </script>
    <span id="gc-{{ .File.UniqueID }}" title="Page views"></span>
</span>